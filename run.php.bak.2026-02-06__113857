<?php

function load_env_file($path) {
  if (!is_readable($path)) return;
  $lines = file($path, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
  foreach ($lines as $line) {
    $line = trim($line);
    if ($line === '' || $line[0] === '#') continue;
    if (strpos($line, '=') === false) continue;
    [$k, $v] = explode('=', $line, 2);
    $k = trim($k);
    $v = trim($v);
    $v = trim($v, "\"'");
    putenv("$k=$v");
    $_ENV[$k] = $v;
    $_SERVER[$k] = $v;
  }
}
load_env_file(__DIR__ . '/.env');


// run.php

set_time_limit(0);
ini_set('max_execution_time', '0');

function slug($s) {
  $s = trim(strtolower($s));
  $s = preg_replace('/^https?:\/\//', '', $s);
  $s = rtrim($s, '/');
  $s = preg_replace('/[^a-z0-9\.\-_]+/', '-', $s);
  return $s ?: 'site';
}

function ensure_dir($path) {
  if (!is_dir($path)) mkdir($path, 0777, true);
}

function save_upload($fileKey, $dstPath) {
  if (!isset($_FILES[$fileKey])) return false;
  if ($_FILES[$fileKey]['error'] !== UPLOAD_ERR_OK) return false;
  return move_uploaded_file($_FILES[$fileKey]['tmp_name'], $dstPath);
}

function save_uploads_array($fileKey, $dstDir, $prefix) {
  if (!isset($_FILES[$fileKey])) return;
  $f = $_FILES[$fileKey];
  if (!is_array($f['name'])) return;

  $count = count($f['name']);
  for ($i = 0; $i < $count; $i++) {
    if (($f['error'][$i] ?? UPLOAD_ERR_NO_FILE) !== UPLOAD_ERR_OK) continue;

    $name = $f['name'][$i] ?? '';
    $ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
    if ($ext === 'jpeg') $ext = 'jpg';
    if (!in_array($ext, ['png', 'jpg'], true)) $ext = 'png';

    $dst = $dstDir . DIRECTORY_SEPARATOR . sprintf('%s_%02d.%s', $prefix, $i + 1, $ext);
    move_uploaded_file($f['tmp_name'][$i], $dst);
  }
}

function list_images_recursive_1_level($dirAbs, $dirRel) {
  if (!is_dir($dirAbs)) return [];

  $out = [];
  $items = scandir($dirAbs);
  foreach ($items as $it) {
    if ($it === '.' || $it === '..') continue;

    $abs = $dirAbs . DIRECTORY_SEPARATOR . $it;
    $rel = $dirRel . '/' . $it;

    if (is_dir($abs)) {
      $sub = scandir($abs);
      foreach ($sub as $f) {
        if ($f === '.' || $f === '..') continue;
        if (!preg_match('/\.(png|jpg|jpeg|webp)$/i', $f)) continue;
        $out[] = [$rel . '/' . $f, $it . '/' . $f];
      }
      continue;
    }

    if (!preg_match('/\.(png|jpg|jpeg|webp)$/i', $it)) continue;
    $out[] = [$rel, $it];
  }

  return $out;
}

$client_domain = trim($_POST['client_domain'] ?? '');
$market = trim($_POST['market'] ?? 'Global');
$language = trim($_POST['language'] ?? 'en');
$mode = 'sales';


$competitors = [];

// from new UI: competitors[]
if (isset($_POST['competitors']) && is_array($_POST['competitors'])) {
  $competitors = $_POST['competitors'];
}

// backward-compat: competitor_1..competitor_5
for ($i = 1; $i <= 5; $i++) {
  $k = 'competitor_' . $i;
  if (isset($_POST[$k])) $competitors[] = $_POST[$k];
}

// normalize + uniq + limit 5
$competitors = array_map(function($x){ return trim((string)$x); }, $competitors);
$competitors = array_values(array_filter($competitors, function($x){ return $x !== ''; }));
$competitors = array_values(array_unique($competitors));
$competitors = array_slice($competitors, 0, 5);

$competitor_1 = $competitors[0] ?? '';

// manual competitor screenshots (optional): пока только для первого конкурента
if ($competitor_1 !== '') {
  save_uploads_array('competitor_files', $uploads_dir, 'competitor__' . slug($competitor_1));
}
$payload = [
  'cmd' => 'run',
  'client_domain' => $client_domain,
  'market' => $market,
  'language' => $language,
  'mode' => $mode,
  'competitors' => $competitors,
  'run_id' => $run_id,
  'semrush_auto' => $semrush_auto,
  'semrush_db' => $semrush_db,
];

$prompts_override_raw = trim($_POST['prompts_override'] ?? '');
if ($prompts_override_raw !== '') {
  $po = json_decode($prompts_override_raw, true);
  if (is_array($po)) {
    $allowed = ['sales_note','report_md','competitor_note','compare','quick_wins'];
    $filtered = [];
    foreach ($allowed as $k) {
      if (isset($po[$k]) && is_string($po[$k]) && trim($po[$k]) !== '') {
        $filtered[$k] = $po[$k];
      }
    }
    if (!empty($filtered)) $payload['prompts_override'] = $filtered;
  }
}


if ($slide_limit > 0) $payload['slide_limit'] = $slide_limit;


// UI prompt overrides (per-run). Only apply if different from defaults.
function _read_default_prompt($rel) {
  $pp = __DIR__ . '/py/radar_py/prompts/default/' . $rel;
  if (!is_readable($pp)) return '';
  return file_get_contents($pp);
}
function _norm_nl($t) {
  return str_replace("\r\n", "\n", (string)$t);
}

$ui_map = [
  'sales_note'      => ['prompt_sales_note',      'sales_note.txt'],
  'report_md'       => ['prompt_report_md',       'report.md'],
  'competitor_note' => ['prompt_competitor_note', 'competitor_note.txt'],
  'compare'         => ['prompt_compare',         'compare.txt'],
  'quick_wins'      => ['prompt_quick_wins',      'quick_wins.txt'],
];

$ui_overrides = [];
foreach ($ui_map as $key => $pair) {
  $field = $pair[0];
  $defFile = $pair[1];
  if (!isset($_POST[$field])) continue;
  $txt = (string)$_POST[$field];
  if (trim($txt) === '') continue;

  $def = _read_default_prompt($defFile);
  $txtN = _norm_nl($txt);
  $defN = _norm_nl($def);

  if ($defN === '' || $txtN !== $defN) {
    $ui_overrides[$key] = $txtN;
  }
}

if (!empty($ui_overrides)) {
  $existing = $payload['prompts_override'] ?? [];
  if (!is_array($existing)) $existing = [];
  $payload['prompts_override'] = array_merge($existing, $ui_overrides);
}

$json = json_encode($payload, JSON_UNESCAPED_UNICODE);

// ВАЖНО для Windows: -X utf8
$cmd = 'py/.venv/bin/python -X utf8 py/cli.py';

$descriptors = [
  0 => ['pipe', 'r'],
  1 => ['pipe', 'w'],
  2 => ['pipe', 'w']
];

$env = [
  'OPENAI_API_KEY' => getenv('OPENAI_API_KEY') ?: '',
  'HOME' => '/var/www',
];
$proc = proc_open($cmd, $descriptors, $pipes, $base, $env);
if (!is_resource($proc)) {
  http_response_code(500);
  echo "Failed to start python";
  exit;
}

fwrite($pipes[0], $json);
fclose($pipes[0]);

$out = stream_get_contents($pipes[1]);
$err = stream_get_contents($pipes[2]);
fclose($pipes[1]);
fclose($pipes[2]);

$code = proc_close($proc);

$res = json_decode($out, true);
?>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radar result</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 12px; }
    pre { white-space: pre-wrap; background:#f6f6f6; padding: 12px; border:1px solid #ddd; }
    .status { display:inline-block; padding:6px 10px; border-radius:8px; font-weight:700; }
    .ok { background:#e8f5e9; border:1px solid #b7e0bb; }
    .bad { background:#ffebee; border:1px solid #f5b7c0; }
    .card { background:#fafafa; border:1px solid #e5e5e5; border-radius:12px; padding:12px; margin:12px 0; }
    .warn { margin-top:10px; padding:10px; background:#fff8e1; border:1px solid #f3d59b; border-radius:10px; }
    .kv { margin:6px 0; color:#333; }
    .grid { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .shot { width: 220px; border:1px solid #e5e5e5; border-radius:12px; overflow:hidden; background:#fff; }
    .shot .lbl { padding:8px; font-size:12px; color:#333; border-bottom:1px solid #eee; }
    .shot img { width:100%; height:140px; object-fit:cover; display:block; }
    details { margin:12px 0; }
    summary { cursor:pointer; font-weight:700; }
  </style>
</head>
<body>
  <h1>Result</h1>

<?php
$ok = is_array($res) && ($res['ok'] ?? false) && intval($code) === 0;

$runDirRel = 'runs/' . $run_id;
$runAbs = __DIR__ . DIRECTORY_SEPARATOR . $runDirRel;

$dataAbs = $runAbs . DIRECTORY_SEPARATOR . 'data.json';
$data = null;
if (is_readable($dataAbs)) {
  $raw = file_get_contents($dataAbs);
  $tmp = json_decode($raw, true);
  if (is_array($tmp)) $data = $tmp;
}

$ssDirRel = $runDirRel . '/screenshots';
$ssDirAbs = __DIR__ . DIRECTORY_SEPARATOR . $ssDirRel;
$imgs = list_images_recursive_1_level($ssDirAbs, $ssDirRel);

$totalImgs = is_array($imgs) ? count($imgs) : 0;
$semrushImgs = 0; $siteImgs = 0; $competitorImgs = 0;

if (is_array($imgs)) {
  foreach ($imgs as $pair) {
    $label = (string)($pair[1] ?? '');
    if (stripos($label, 'semrush') === 0) $semrushImgs++;
    else if (stripos($label, 'site') === 0) $siteImgs++;
    else if (stripos($label, 'competitor') === 0) $competitorImgs++;
  }
}

$blocked = null;
if (is_array($data)) $blocked = $data['metrics']['site']['blocked'] ?? null;

$hasSemrush = false;
if (is_array($data)) {
  $sf = $data['sources']['semrush_files'] ?? [];
  if (is_array($sf) && count($sf) > 0) $hasSemrush = true;
  if (!$hasSemrush && !empty($data['sources']['semrush_overview_screenshot'])) $hasSemrush = true;
}

$zipRel = $runDirRel . '/run.zip';
$zipAbs = __DIR__ . DIRECTORY_SEPARATOR . $zipRel;

if ($ok) {
  if (file_exists($zipAbs)) { @unlink($zipAbs); }

  $parts = [];
  foreach (['sales_note.txt','report.md','data.json','data.csv'] as $f) {
    if (file_exists($runAbs . DIRECTORY_SEPARATOR . $f)) $parts[] = escapeshellarg($f);
  }
  foreach (['screenshots','uploads'] as $d) {
    if (is_dir($runAbs . DIRECTORY_SEPARATOR . $d)) $parts[] = escapeshellarg($d);
  }
  if (!empty($parts)) {
    $cmdZip = 'cd ' . escapeshellarg($runAbs) . ' && zip -r ' . escapeshellarg('run.zip') . ' ' . implode(' ', $parts);
    @shell_exec($cmdZip);
  }
}
?>

  <?php if ($ok): ?>
    <div class="status ok">OK</div>

    <div class="card">
      <div class="kv">Скрины: сайт <?php echo intval($siteImgs); ?>, Semrush <?php echo intval($semrushImgs); ?>, конкуренты <?php echo intval($competitorImgs); ?>.</div>
      <div class="kv">Market: <?php echo htmlspecialchars($market); ?>. Language: <?php echo htmlspecialchars($language); ?>.</div>

      <?php if ($blocked): ?>
        <div class="warn">Сайт отвечает как для бота. Нужен blocked screen или ручные скрины.</div>
      <?php endif; ?>

      <?php if (!$hasSemrush): ?>
        <div class="warn">
          Нет Semrush-скринов.<br/>
          Починка:<br/>
          - Включить Semrush auto screenshots и один раз залогиниться.<br/>
          - Или загрузить вручную 2–6 Semrush картинок.
        </div>
      <?php endif; ?>
    </div>

    <h2>Artifacts</h2>
    <ul>
      <li><a href="<?php echo $runDirRel . '/sales_note.txt'; ?>">sales_note.txt</a></li>
      <li><a href="<?php echo $runDirRel . '/report.md'; ?>">report.md</a></li>
      <li><a href="<?php echo $runDirRel . '/data.json'; ?>">data.json</a></li>
      <li><a href="<?php echo $runDirRel . '/data.csv'; ?>">data.csv</a></li>
    </ul>

    <?php if (file_exists($zipAbs)) { ?>
      <p><a href="<?php echo htmlspecialchars($zipRel); ?>">Download ZIP</a></p>
    <?php } ?>

    <details>
      <summary>Screenshots</summary>
      <div class="grid">
        <?php
          if (is_array($imgs)) {
            foreach ($imgs as $pair) {
              $src = (string)($pair[0] ?? '');
              $label = (string)($pair[1] ?? '');
              $href = $src;
              echo '<div class="shot">';
              echo '<div class="lbl">' . htmlspecialchars($label) . '</div>';
              echo '<a target="_blank" rel="noopener" href="' . htmlspecialchars($href) . '">';
              echo '<img loading="lazy" src="' . htmlspecialchars($src) . '" />';
              echo '</a>';
              echo '</div>';
            }
          }
        ?>
      </div>
    </details>

    <details>
      <summary>Debug</summary>
      <pre><?php echo htmlspecialchars("exit_code=$code\n\nstdout:\n$out\n\nstderr:\n$err"); ?></pre>
    </details>

  <?php else: ?>
    <div class="status bad">НЕ OK</div>

    <div class="card">
      <div class="warn">Сбой запуска. Ниже отладка.</div>
    </div>

    <details open>
      <summary>Debug</summary>
      <pre><?php echo htmlspecialchars("exit_code=$code\n\nstdout:\n$out\n\nstderr:\n$err"); ?></pre>
    </details>
  <?php endif; ?>

</body>
</html>
